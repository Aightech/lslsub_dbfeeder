//g++ main.cpp -lpqxx -lpq
#include <iostream>
#include <pqxx/pqxx>
#include <string>

using namespace std;
using namespace pqxx;

void error(std::string str)
{
  std::cout << str << std::endl;
  exit(0);
}

int main(int argc, char* argv[])
{
  connection C *;
  try
    {
      std::string conParam=
	"dbname = lsldb "\
	"user = postgres "\
	"password = azerty "\
	"hostaddr = 127.0.0.1 "\
	"port = 5432";
      std::cout << "Connecting to lsldb...\xd" << std::flush;
      C = new connection(conParam);
    }
  catch (const pqxx::broken_connection &e)
    {
      std::string str = "FATAL:  database \"lsldb\" does not exist";
      std::string except = (std::string)(e.what());
      if (except.find(str) == 0)
	std::cout << "Should create database" << '\n';
      std::cerr  << e.what() << std::endl;
    }
    
      if (!C->is_open())
        error("Connection to lsldb failed.");
      
      std::cout << "Connected to lsldb       " << std::endl;


      std::string sql=
	"INSERT INTO sensors "\
	"VALUES "\
	"(NOW(), 'office', 30.2),"
	"(NOW(), 'office', 30.1);";

      work W(C*);
      
      /* Execute SQL query */
      W.exec( sql );
      W.commit();
	
      std::cout << "Disconnecting from lsldb...\xd" << std::flush;
      C->disconnect ();
      std::cout << "Disconnected from lsldb.       " << std::endl;
    
}
